# This is a GitHub Actions workflow file
# It defines automated tests and documentation deployment

# Name of this workflow as it appears in GitHub Actions tab
name: Python CI, Tests, and Docs

# Define when this workflow should be triggered
on:
  # Run when code is pushed to the main branch
  push:
    branches: [ main ]
  # Also run when pull requests are created or updated targeting main branch
  pull_request:
    branches: [ main ]

# Jobs are the main building blocks of a workflow
# Each job runs in a fresh virtual environment
jobs:
  # Job 1: Run linter and test suite
  test:
    # Specify the operating system for the runner
    runs-on: ubuntu-latest

    # Steps are individual tasks that run sequentially in the job
    steps:
    # Step 1: Check out the repository code
    - name: Checkout code
      uses: actions/checkout@v5

    # Step 2: Set up Python environment
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.10'
    
    # Step 3: Install Python dependencies
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    # Step 4: Lint the code with flake8
    - name: Lint with flake8
      run: |
        pip install flake8
        # Critical error check
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # Style check (non-blocking)
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    
    # Step 5: Run the actual test suite
    - name: Run test suite
      run: python run_tests.py

  # Job 2: Build and deploy documentation
  build-and-deploy-docs:
    # This job runs only after the 'test' job has successfully completed
    needs: test
    
    # This job only runs on a push to the 'main' branch
    # We don't want to deploy docs from Pull Requests
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    # Specify the runner
    runs-on: ubuntu-latest

    # Grant permissions for GitHub Pages deployment
    permissions:
      contents: read
      pages: write      # to deploy to Pages
      id-token: write   # to verify the deployment source

    # Specify the deployment environment for GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      # Step 1: Check out the code
      - name: Checkout code
        uses: actions/checkout@v5

      # Step 2: Set up Python
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.10'

      # Step 3: Generate documentation with pydoc
      # pydoc is a built-in Python module, so no installation is needed.
      - name: Generate documentation
        run: |
          # Create the output directory
          mkdir -p ./docs
          
          # Generate documentation for each module.
          # pydoc -w <module_name> writes <module_name>.html to the current directory
          python -m pydoc -w choice_processor
          python -m pydoc -w combat
          
          # Move the generated HTML files into the docs directory
          # We also create a simple index.html to link to the module pages,
          # as GitHub Pages needs an index file.
          mv choice_processor.html combat.html ./docs/
          echo "<h1>Project Documentation</h1><ul><li><a href='choice_processor.html'>choice_processor</a></li><li><a href='combat.html'>combat</a></li></ul>" > ./docs/index.html

      # Step 5: Configure GitHub Pages
      - name: Setup Pages
        uses: actions/configure-pages@v5

      # Step 6: Upload documentation artifact
      # This packages the ./docs directory for deployment
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './docs'

      # Step 7: Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4